package downloader

import (
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"os"
	"strings"
)

func (d *Downloader) downloadTikTokViaAPI(videoID, cookiesPath, outputPath string) (string, error) {
	client := &http.Client{}
	url := fmt.Sprintf("https://api16-normal-c-useast1a.tiktokv.com/aweme/v1/multi/aweme/detail/?aweme_ids=%%5B%s%%5D", videoID)
	req, err := http.NewRequest("GET", url, nil)
	if err != nil {
		return "", fmt.Errorf("ошибка создания запроса: %v", err)
	}

	req.Header.Set("User-Agent", "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148")
	req.Header.Set("Referer", "https://www.tiktok.com/")
	req.Header.Set("Origin", "https://www.tiktok.com")

	if _, err := os.Stat(cookiesPath); err == nil {
		cookiesData, err := os.ReadFile(cookiesPath)
		if err == nil {
			for _, line := range strings.Split(string(cookiesData), "\n") {
				if strings.HasPrefix(line, "#") || line == "" {
					continue
				}
				parts := strings.Fields(line)
				if len(parts) >= 7 {
					req.AddCookie(&http.Cookie{
						Name:   parts[5],
						Value:  parts[6],
						Domain: parts[0],
					})
				}
			}
		}
	}

	resp, err := client.Do(req)
	if err != nil {
		return "", fmt.Errorf("ошибка выполнения запроса: %v", err)
	}
	defer resp.Body.Close()

	body, err := io.ReadAll(resp.Body)
	if err != nil {
		return "", fmt.Errorf("ошибка чтения ответа: %v", err)
	}

	// Парсинг JSON
	var result struct {
		AwemeDetails []struct {
			Video struct {
				PlayAddr struct {
					Uri     string   `json:"uri"`
					UrlList []string `json:"url_list"`
				} `json:"play_addr"`
			} `json:"video"`
		} `json:"aweme_details"`
	}
	if err := json.Unmarshal(body, &result); err != nil {
		return "", fmt.Errorf("ошибка парсинга JSON: %v", err)
	}

	if len(result.AwemeDetails) == 0 || len(result.AwemeDetails[0].Video.PlayAddr.UrlList) == 0 {
		return "", fmt.Errorf("не найдены URL видео в ответе API")
	}

	videoURL := result.AwemeDetails[0].Video.PlayAddr.UrlList[0]
	fmt.Printf("Найден URL видео: %s\n", videoURL)

	// Скачиваем видео
	resp, err = http.Get(videoURL)
	if err != nil {
		return "", fmt.Errorf("ошибка скачивания видео: %v", err)
	}
	defer resp.Body.Close()

	out, err := os.Create(outputPath)
	if err != nil {
		return "", fmt.Errorf("ошибка создания файла: %v", err)
	}
	defer out.Close()

	_, err = io.Copy(out, resp.Body)
	if err != nil {
		return "", fmt.Errorf("ошибка записи файла: %v", err)
	}

	return outputPath, nil
}